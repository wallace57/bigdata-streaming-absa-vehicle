FROM apache/airflow:2.9.0

USER root

# C√†i Java (cho Spark)
RUN apt-get update && apt-get install -y --no-install-recommends openjdk-17-jre-headless \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# N·∫øu l√† win th√¨ ch·∫°y ƒëo·∫°n n√†y
#ENV JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
#ENV PATH="${JAVA_HOME}/bin:${PATH}"

# N·∫øu l√† mac th√¨ ch·∫°y ƒë·ªçan n√†y
# Start for Mac chip M
# ==== C√†i Java 17 ====
RUN apt-get update && apt-get install -y --no-install-recommends \
    openjdk-17-jre-headless ca-certificates \
 && rm -rf /var/lib/apt/lists/*

# ==== T·ª± d√≤ JAVA_HOME v√† thi·∫øt l·∫≠p vƒ©nh vi·ªÖn ====
# Ho·∫°t ƒë·ªông cho c·∫£ amd64/arm64 v√¨ l·∫•y theo /usr/bin/java th·ª±c t·∫ø
RUN set -eux; \
    JAVA_BIN="$(readlink -f /usr/bin/java)"; \
    JAVA_HOME_DIR="$(dirname "$(dirname "$JAVA_BIN")")"; \
    # t·∫°o alias ·ªïn ƒë·ªãnh
    ln -sf "$JAVA_HOME_DIR" /usr/lib/jvm/default-jre; \
    # ƒë·ªÉ non-login shells (Airflow tasks) nh√¨n th·∫•y
    echo "JAVA_HOME=$JAVA_HOME_DIR" > /etc/environment; \
    # ƒë·ªÉ login shells / interactive c≈©ng th·∫•y
    printf 'export JAVA_HOME=%s\nexport PATH=$JAVA_HOME/bin:$PATH\n' "$JAVA_HOME_DIR" > /etc/profile.d/java_home.sh; \
    chmod +x /etc/profile.d/java_home.sh; \
    # sanity check
    "$JAVA_HOME_DIR/bin/java" -version \

# End for Mac chip M

# Copy file requirements trong ch√≠nh th∆∞ m·ª•c base
COPY base/requirements.txt /tmp/base_requirements.txt

USER airflow
RUN pip install --no-cache-dir -r /tmp/base_requirements.txt && \
    # Fix l·ªói kafka.vendor.six.moves kh√¥ng t·ªìn t·∫°i trong kafka-python 2.0.1
    sed -i "s|from kafka.vendor.six.moves import range|from six.moves import range|" \
    /home/airflow/.local/lib/python3.*/site-packages/kafka/codec.py || true

# ================================
# üîß Copy scripts v√† c·∫•p quy·ªÅn th·ª±c thi (chu·∫©n reproducible)
# ================================
USER root
COPY projects/absa_streaming/scripts /opt/airflow/projects/absa_streaming/scripts
RUN chmod +x /opt/airflow/projects/absa_streaming/scripts/*.sh
# Copy th∆∞ m·ª•c streamlit c·ªßa project v√†o image
COPY projects/absa_streaming/streamlit /opt/airflow/projects/absa_streaming/streamlit

# Project VEHICLE COUNTING m·ªõi
COPY projects/vehicle_count/scripts /opt/airflow/projects/vehicle_count/scripts
COPY projects/vehicle_count/data /opt/airflow/projects/vehicle_count/data
COPY projects/vehicle_count/streamlit /opt/airflow/projects/vehicle_count/streamlit
RUN chmod +x /opt/airflow/projects/vehicle_count/scripts/*.sh

USER airflow
# C√†i c√°c th∆∞ vi·ªán c·∫ßn thi·∫øt cho Streamlit
USER airflow
RUN pip install --no-cache-dir streamlit psycopg2-binary pandas

# [A] D√πng headless (khuy√™n d√πng)
RUN pip uninstall -y opencv-python opencv-contrib-python
RUN pip install --no-cache-dir opencv-python-headless==4.9.0.80
#RUN pip install --no-cache-dir opencv-python-headless==4.11.0.86
